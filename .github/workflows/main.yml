name: YouTube Multi Cut Pro

on:
  workflow_dispatch:
    inputs:
      url:
        description: "🎬 URL YouTube"
        required: true
      segments:
        description: "✂️ Daftar segmen (format: 00:05:25-00:05:50,00:10:00-00:10:30,...)"
        required: true
      resolution:
        description: "📺 Resolusi maksimal (720,1080,1440,2160)"
        required: true
        default: "1080"
      fps:
        description: "🎞️ FPS (30/60/120)"
        required: true
        default: "30"
      bitrate:
        description: "💾 Bitrate video (auto atau misal: 2M, 4M, 8M)"
        required: true
        default: "auto"
      mode:
        description: "📂 Output mode: pisah (per segmen) atau gabung (satu file)"
        required: true
        default: "pisah"

jobs:
  cut:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install yt-dlp & ffmpeg
        run: |
          pip install -U yt-dlp
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Buat file cookies dari Secret
        run: |
          echo "${{ secrets.YT_COOKIES }}" > cookies.txt

      - name: Potong video sesuai segmen + encode ulang
        run: |
          URL="${{ github.event.inputs.url }}"
          SEGMENTS="${{ github.event.inputs.segments }}"
          RES="${{ github.event.inputs.resolution }}"
          FPS="${{ github.event.inputs.fps }}"
          BITRATE="${{ github.event.inputs.bitrate }}"
          MODE="${{ github.event.inputs.mode }}"

          i=1
          mkdir outputs

          # Split input jadi array segmen (pisah koma)
          IFS=',' read -ra SEGARR <<< "$SEGMENTS"
          for SEG in "${SEGARR[@]}"; do
            echo "🎬 Download segmen $SEG ..."
            yt-dlp --cookies cookies.txt --download-sections "*$SEG" \
              -f "bestvideo[height<=${RES}]+bestaudio/best" \
              -o "raw_${i}.%(ext)s" \
              "$URL"

            RAWFILE=$(ls raw_${i}.* | head -n 1)

            if [ "$BITRATE" = "auto" ]; then
              ffmpeg -i "$RAWFILE" \
                -c:v libx264 -preset fast -crf 23 \
                -vf "fps=${FPS},scale=-2:${RES}" \
                -c:a aac -b:a 192k \
                -movflags +faststart \
                "outputs/segment_${i}.mp4"
            else
              ffmpeg -i "$RAWFILE" \
                -c:v libx264 -preset fast -b:v ${BITRATE} \
                -vf "fps=${FPS},scale=-2:${RES}" \
                -c:a aac -b:a 192k \
                -movflags +faststart \
                "outputs/segment_${i}.mp4"
            fi

            rm "$RAWFILE"
            ((i++))
          done

          if [ "$MODE" = "gabung" ]; then
            echo "📂 Gabung semua segmen..."
            for f in outputs/segment_*.mp4; do
              echo "file '$f'" >> file_list.txt
            done
            ffmpeg -f concat -safe 0 -i file_list.txt -c copy outputs/final.mp4
          fi

      - name: Upload hasil
        uses: actions/upload-artifact@v4
        with:
          name: youtube-segments
          path: outputs/*
