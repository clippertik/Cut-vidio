name: YouTube Multi-Cut (format singkat)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "🎬 Masukkan URL YouTube"
        required: true
      seg1:
        description: "⏱️ Segment 1 (format: 00:01:00-00:01:30)"
        required: true
      seg2:
        description: "⏱️ Segment 2 (opsional, format sama)"
        required: false
      seg3:
        description: "⏱️ Segment 3 (opsional, format sama)"
        required: false
      resolution:
        description: "Resolusi maksimal"
        required: true
        type: choice
        options: ["720", "1080", "1440", "2160"]
        default: "1080"
      fps:
        description: "FPS target"
        required: true
        type: choice
        options: ["original", "24", "30", "60", "120"]
        default: "original"
      bitrate:
        description: "Bitrate video"
        required: true
        type: choice
        options: ["auto", "5M", "10M", "20M"]
        default: "auto"

jobs:
  cut:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y ffmpeg
          pip install yt-dlp

      - name: Buat file cookies dari Secret
        run: |
          echo "${{ secrets.YT_COOKIES }}" > cookies.txt

      - name: Download video asli
        run: |
          yt-dlp --cookies cookies.txt \
            -f "bestvideo[height<=${{ github.event.inputs.resolution }}]+bestaudio/best[height<=${{ github.event.inputs.resolution }}]" \
            -o "source.%(ext)s" \
            "${{ github.event.inputs.url }}"

      - name: Potong video jadi beberapa segmen
        run: |
          # Fungsi bantu untuk split segmen "start-end"
          cut_segment () {
            local range="$1"
            local outfile="$2"
            local start="${range%-*}"
            local end="${range#*-}"

            # Tentukan argumen FPS
            if [ "${{ github.event.inputs.fps }}" = "original" ]; then
              FPS_ARG=""
            else
              FPS_ARG="-r ${{ github.event.inputs.fps }}"
            fi

            # Tentukan argumen bitrate
            if [ "${{ github.event.inputs.bitrate }}" = "auto" ]; then
              BITRATE_ARG=""
            else
              BITRATE_ARG="-b:v ${{ github.event.inputs.bitrate }}"
            fi

            ffmpeg -i source.* -ss "$start" -to "$end" \
              -c:v libx264 -preset fast -crf 23 $FPS_ARG $BITRATE_ARG \
              -c:a aac -b:a 192k -movflags +faststart \
              "$outfile"
          }

          cut_segment "${{ github.event.inputs.seg1 }}" clip1.mp4

          if [ -n "${{ github.event.inputs.seg2 }}" ]; then
            cut_segment "${{ github.event.inputs.seg2 }}" clip2.mp4
          fi

          if [ -n "${{ github.event.inputs.seg3 }}" ]; then
            cut_segment "${{ github.event.inputs.seg3 }}" clip3.mp4
          fi

      - name: Upload hasil
        uses: actions/upload-artifact@v4
        with:
          name: youtube-multi-cut
          path: clip*.mp4
