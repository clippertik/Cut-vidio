name: YouTube Multi-Cut (Safe H264)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "URL YouTube"
        required: true
      segments:
        description: "Segmen waktu (contoh: 01:14:00-01:14:23 02:00:00-02:00:25)"
        required: true
      resolution:
        description: "Resolusi maksimal"
        required: true
        type: choice
        options: [ "720", "1080", "1440", "2160" ]
        default: "1080"
      fps:
        description: "FPS target"
        required: true
        type: choice
        options: [ "original", "24", "30", "60", "120" ]
        default: "original"
      bitrate:
        description: "Bitrate video"
        required: true
        type: choice
        options: [ "auto", "5M", "10M", "20M" ]
        default: "auto"

jobs:
  cut:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y ffmpeg jq
          pip install yt-dlp

      - name: Buat cookies dari Secret
        run: echo "${{ secrets.YT_COOKIES }}" > cookies.txt

      - name: Potong video langsung dari YouTube
        run: |
          if [ "${{ github.event.inputs.fps }}" = "original" ]; then
            FPS_ARG=""
          else
            FPS_ARG="--postprocessor-args \"-r ${{ github.event.inputs.fps }}\""
          fi

          if [ "${{ github.event.inputs.bitrate }}" = "auto" ]; then
            BITRATE_ARG=""
          else
            BITRATE_ARG="--postprocessor-args \"-b:v ${{ github.event.inputs.bitrate }}\""
          fi

          i=1
          for SEG in ${{ github.event.inputs.segments }}; do
            echo "ðŸŽ¬ Potong segmen $SEG ..."

            yt-dlp --cookies cookies.txt \
              -f "bv*[vcodec^=avc1][height<=${{ github.event.inputs.resolution }}]+ba/b[height<=${{ github.event.inputs.resolution }}]" \
              --download-sections "*$SEG" \
              --merge-output-format mp4 \
              -o "clip${i}.%(ext)s" \
              "${{ github.event.inputs.url }}" || true

            # kalau hasil bukan mp4 â†’ re-encode ke mp4 (H264 + AAC)
            if [ -f "clip${i}.webm" ]; then
              echo "âš¡ Convert clip${i}.webm ke MP4..."
              ffmpeg -i "clip${i}.webm" -c:v libx264 -preset fast -crf 23 -c:a aac "clip${i}.mp4"
              rm -f "clip${i}.webm"
            fi

            i=$((i+1))
          done

      - name: Upload hasil
        uses: actions/upload-artifact@v4
        with:
          name: youtube-multi-cut
          path: "*.mp4"

      - name: Bersihkan file lama
        run: rm -f source.* clip*.webm
