name: YouTube Multi Cut (custom res/fps/bitrate)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "ğŸ¬ URL YouTube"
        required: true
      segment1:
        description: "âœ‚ï¸ Segmen 1 (format: 00:05:25-00:05:50)"
        required: true
      segment2:
        description: "âœ‚ï¸ Segmen 2 (opsional)"
        required: false
      segment3:
        description: "âœ‚ï¸ Segmen 3 (opsional)"
        required: false
      resolution:
        description: "ğŸ“º Resolusi maksimal (contoh: 720, 1080, 1440, 2160)"
        required: true
        default: "1080"
      fps:
        description: "ğŸï¸ FPS (pilihan: 30, 60, 120)"
        required: true
        default: "30"
      bitrate:
        description: "ğŸ’¾ Bitrate video (isi 'auto' atau contoh: 2M, 4M, 8M)"
        required: true
        default: "auto"

jobs:
  cut:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install yt-dlp & ffmpeg
        run: |
          pip install -U yt-dlp
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Potong video sesuai segmen + encode ulang
        run: |
          URL="${{ github.event.inputs.url }}"
          SEG1="${{ github.event.inputs.segment1 }}"
          SEG2="${{ github.event.inputs.segment2 }}"
          SEG3="${{ github.event.inputs.segment3 }}"
          RES="${{ github.event.inputs.resolution }}"
          FPS="${{ github.event.inputs.fps }}"
          BITRATE="${{ github.event.inputs.bitrate }}"

          i=1
          for SEG in "$SEG1" "$SEG2" "$SEG3"; do
            if [ ! -z "$SEG" ]; then
              echo "ğŸ¬ Download segmen $SEG ..."
              yt-dlp --download-sections "*$SEG" \
                -f "bestvideo[height<=${RES}]+bestaudio/best" \
                -o "raw_${i}.%(ext)s" \
                "$URL"

              RAWFILE=$(ls raw_${i}.* | head -n 1)

              if [ "$BITRATE" = "auto" ]; then
                echo "âš™ï¸ Encode ulang (auto bitrate, CRF 23, ${FPS} fps, ${RES}p)..."
                ffmpeg -i "$RAWFILE" \
                  -c:v libx264 -preset fast -crf 23 \
                  -vf "fps=${FPS},scale=-2:${RES}" \
                  -c:a aac -b:a 192k \
                  -movflags +faststart \
                  "segment_${i}.mp4"
              else
                echo "âš™ï¸ Encode ulang (manual bitrate ${BITRATE}, ${FPS} fps, ${RES}p)..."
                ffmpeg -i "$RAWFILE" \
                  -c:v libx264 -preset fast -b:v ${BITRATE} \
                  -vf "fps=${FPS},scale=-2:${RES}" \
                  -c:a aac -b:a 192k \
                  -movflags +faststart \
                  "segment_${i}.mp4"
              fi

              rm "$RAWFILE"
              ((i++))
            fi
          done

      - name: Upload hasil
        uses: actions/upload-artifact@v4
        with:
          name: youtube-segments
          path: segment_*.mp4
